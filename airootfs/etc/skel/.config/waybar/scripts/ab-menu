#!/usr/bin/env bash
# ArchBANG main menu for Waybar â†’ Rofi (Sway Wayland)
# Flat main menu: Terminal, Files, Browser, System (submenu), Power (submenu with confirms)
# Adapted from SwayBang for Sway
# Author: Mr Green

set -euo pipefail

ROFI="${ROFI:-rofi}"
DM() {
  local prompt="$1"
  local line_count="$2"
  "$ROFI" -dmenu -i -p "$prompt" -lines "$line_count"
}
have() { command -v "$1" >/dev/null 2>&1; }

# Fixed apps
TERM="foot"
FILEMGR="thunar"
BROWSER="firefox"

# Document paths
GUIDE_PATH="$HOME/Documents/Guide"
KEYBINDS_PATH="$HOME/Documents/keybinds.txt"

# --- Confirm function ---
confirm() { choice=$(printf "No\nYes" | DM "$1" 2) || exit 0; [ "$choice" = "Yes" ]; }

# --- Main unified menu ---
main_menu() {
  local menu_items=(
    "  Reload Sway"
    "  Restart Waybar"
    "  Lock"
    "  Suspend"
    "  Reboot"
    "  Shutdown"
    "  Logout"
  )
  have abinstall && menu_items+=("  Install ArchBANG")
  have gparted && menu_items+=("  GParted")
  [ -f "$GUIDE_PATH" ]    && menu_items+=("  Guide")
  [ -f "$KEYBINDS_PATH" ] && menu_items+=("  Keybinds")

  sel=$(printf "%s\n" "${menu_items[@]}" | DM ">" "${#menu_items[@]}") || exit 0
  case "$sel" in
    *Reload\ Sway*)        exec swaymsg reload ;;
    *Restart\ Waybar*)     pkill -x waybar; waybar & disown ;;
    *Lock*)                have swaylock && exec swaylock ;;
    *Suspend*)             confirm "Suspend?"   && exec systemctl suspend ;;
    *Reboot*)              confirm "Reboot?"    && exec systemctl reboot ;;
    *Shutdown*)            confirm "Power off?" && exec systemctl poweroff ;;
    *Logout*)              confirm "Exit Sway?" && pkill -x sway ;;
    *Install\ ArchBANG*)   exec foot -e sudo -E "$HOME/AB_Scripts/abinstall" ;;
    *GParted*)
      notify-send "GParted" "Running GParted as root" --icon=gparted
      sudo -EH gparted & disown
      ;;
    *Guide*)               exec "$BROWSER" "$GUIDE_PATH" ;;
    *Keybinds*)            exec l3afpad "$KEYBINDS_PATH" ;;
  esac
}

main_menu
